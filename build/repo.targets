<Project>

  <PropertyGroup>
      <SiteExtensionProjectDirectory>$(RepositoryRoot)src\Microsoft.AspNetCore.AzureAppServices.TestBundle\</SiteExtensionProjectDirectory>
      <SiteExtensionFeed Condition="$(SiteExtensionFeed) == ''">https://dotnet.myget.org/F/aspnetcore-ci-dev/</SiteExtensionFeed>
      <DotnetChannel>master</DotnetChannel>
      <DotnetVersion>coherent</DotnetVersion>
  </PropertyGroup>

  <Target Name="BuildSiteExtension">

    <PropertyGroup>
      <SiteExtensionWorkingDirectory>$(RepositoryRoot).test-dotnet\</SiteExtensionWorkingDirectory>
      <CliVersionRelativePath>build\dotnet.version</CliVersionRelativePath>
    </PropertyGroup>

    <RemoveDir Directories="$(SiteExtensionWorkingDirectory)" />
    <Exec Command="$(MSBuildThisFileDirectory)\dotnet-install.cmd -Channel $(DotnetChannel) -Version $(DotnetVersion) -Architecture x86 -InstallDir $(SiteExtensionWorkingDirectory) -NoPath" />
    <MSBuild Projects="$(SiteExtensionProjectDirectory)Microsoft.AspNetCore.AzureAppServices.TestBundle.csproj"
      Targets="Restore;Pack"
      Properties="DotnetHomeDirectory=$(SiteExtensionWorkingDirectory)" />

    <Exec Command="$(SiteExtensionWorkingDirectory)dotnet --version > $(RepositoryRoot)artifacts\$(CliVersionRelativePath)" />
  </Target>

  <Target Name="PushSiteExtension">
    <ItemGroup>
      <RepositoryNupkgs Include="$(SiteExtensionProjectDirectory)bin\$(Configuration)\*.nupkg" />
    </ItemGroup>

    <PushNuGetPackages
      Packages="@(RepositoryNupkgs)"
      Feed="$(SiteExtensionFeed)"
      ApiKey="$(APIKey)"
      TimeoutSeconds="600"/>

  </Target>

</Project>
