<Project>

  <PropertyGroup>
      <TestDotNetPath>$(RepositoryRoot).test-dotnet\</TestDotNetPath>
      <SiteExtensionWorkingDirectory>$(TestDotNetPath)extension\</SiteExtensionWorkingDirectory>
      <SiteExtensionProjectDirectory>$(RepositoryRoot)src\Microsoft.AspNetCore.AzureAppServices.TestBundle\</SiteExtensionProjectDirectory>
      <SiteExtensionFeed Condition="$(SiteExtensionFeed) == ''">https://dotnet.myget.org/F/aspnetcore-ci-dev/</SiteExtensionFeed>
      <DotnetChannel>master</DotnetChannel>
      <DotnetVersion>coherent</DotnetVersion>
  </PropertyGroup>

  <ItemGroup>
    <DotNetCoreSdk Include="2.0.0" InstallDir="$(TestDotNetPath)2.0\" Condition="'$(AntaresTests)' != ''"/>
    <DotNetCoreSdk Include="1.0.4" InstallDir="$(TestDotNetPath)1.1\" Condition="'$(AntaresTests)' != ''"/>
    <DotNetCoreSdk Include="coherent" Channel="master" InstallDir="$(TestDotNetPath)latest\" Condition="'$(AntaresTests)' != ''"/>
  </ItemGroup>

  <Target Name="_AddSiteExtensionRuntimes">
    <ItemGroup>
      <DotNetCoreSdk Include="coherent" Channel="master" InstallDir="$(SiteExtensionWorkingDirectory)" Arch="x86" />
    </ItemGroup>
  </Target>

  <Target Name="BuildSiteExtension" DependsOnTargets="_AddSiteExtensionRuntimes;InstallDotNet">

    <PropertyGroup>
      <CliVersionRelativePath>build\dotnet.version</CliVersionRelativePath>
    </PropertyGroup>

    <MSBuild Projects="$(SiteExtensionProjectDirectory)Microsoft.AspNetCore.AzureAppServices.TestBundle.csproj"
      Targets="Restore;Pack"
      Properties="DotnetHomeDirectory=$(SiteExtensionWorkingDirectory);BuildNumber=$(BuildNumber)" />

  </Target>

  <Target Name="PushSiteExtension">
    <ItemGroup>
      <RepositoryNupkgs Include="$(SiteExtensionProjectDirectory)bin\$(Configuration)\*.nupkg" />
    </ItemGroup>

    <PushNuGetPackages
      Packages="@(RepositoryNupkgs)"
      Feed="$(SiteExtensionFeed)"
      ApiKey="$(APIKey)"
      TimeoutSeconds="600"/>

  </Target>

</Project>
